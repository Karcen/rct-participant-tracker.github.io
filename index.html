<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>疫苗RCT实验邮件统计系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36D399',
                        warning: '#FFAB00',
                        danger: '#F87272',
                        success: '#10B981',
                        dark: '#1F2937',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'pulse-soft': 'pulseSoft 2s infinite',
                        'bounce-gentle': 'bounceGentle 1s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass-effect {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .card-hover {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .card-hover:hover {
                transform: translateY(-8px);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes pulseSoft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes bounceGentle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .text-shadow {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .border-gradient {
            border-image: linear-gradient(45deg, #165DFF, #36D399) 1;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50 font-inter">
    <!-- 顶部导航 -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-gray-200/50 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-xl flex items-center justify-center">
                        <i class="fa fa-bullseye text-white text-lg"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900 text-shadow">疫苗RCT实验邮件统计系统</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="helpBtn" class="p-2 text-gray-600 hover:text-primary transition-colors">
                        <i class="fa fa-question-circle text-lg"></i>
                    </button>
                    <button id="resetBtn" class="p-2 text-gray-600 hover:text-danger transition-colors">
                        <i class="fa fa-bullseye text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 主要内容区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 输入区域 -->
            <div class="space-y-6 animate-slide-up">
                <!-- 数据输入卡片 -->
                <div class="bg-white rounded-2xl shadow-xl p-6 card-hover border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-900 flex items-center">
                            <i class="fa fa-edit text-primary mr-3"></i>
                            数据输入
                        </h2>
                        <span class="text-sm text-gray-500">粘贴格式：姓名 + 状态</span>
                    </div>
                    
                    <div class="space-y-4">
                        <textarea 
                            id="dataInput" 
                            placeholder="请粘贴数据，格式如下：&#10;张三 已发送，退订的未发送&#10;李四 已发送 无退订&#10;王五 未发送"
                            class="w-full h-64 p-4 border border-gray-200 rounded-xl resize-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300 font-mono text-sm"
                        ></textarea>
                        
                        <div class="flex space-x-3">
                            <button 
                                id="analyzeBtn" 
                                class="flex-1 bg-gradient-to-r from-primary to-secondary text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center space-x-2"
                            >
                                <i class="fa fa-magic"></i>
                                <span>开始分析</span>
                            </button>
                            <button 
                                id="pasteBtn" 
                                class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all duration-300 flex items-center justify-center space-x-2"
                            >
                                <i class="fa fa-clipboard"></i>
                                <span>粘贴</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 数据库管理卡片 -->
                <div class="bg-white rounded-2xl shadow-xl p-6 card-hover border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-900 flex items-center">
                            <i class="fa fa-database text-secondary mr-3"></i>
                            人员数据库
                        </h2>
                        <button id="manageDBBtn" class="text-primary hover:text-primary/80 text-sm font-medium">
                            管理 <i class="fa fa-chevron-right ml-1 text-xs"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <textarea 
                            id="databaseInput" 
                            placeholder="请输入完整的人员名单，每行一个姓名"
                            class="w-full h-48 p-4 border border-gray-200 rounded-xl resize-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all duration-300 font-mono text-sm"
                        ></textarea>
                        
                        <div class="flex space-x-3">
                            <button 
                                id="saveDBBtn" 
                                class="flex-1 bg-secondary text-white py-2 px-4 rounded-xl font-semibold hover:bg-secondary/90 transition-all duration-300"
                            >
                                保存数据库
                            </button>
                            <button 
                                id="loadSampleBtn" 
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all duration-300 text-sm"
                            >
                                加载示例
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 统计结果区域 -->
            <div class="space-y-6 animate-slide-up" style="animation-delay: 0.2s">
                <!-- 统计概览卡片 -->
                <div class="bg-white rounded-2xl shadow-xl p-6 card-hover border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900 flex items-center">
                            <i class="fa fa-bar-chart text-warning mr-3"></i>
                            统计概览
                        </h2>
                        <span id="totalCount" class="text-2xl font-bold text-primary">0</span>
                    </div>
                    
                    <!-- 统计指标网格 -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-blue-600 font-medium">已发送</p>
                                    <p id="sentCount" class="text-2xl font-bold text-blue-900">0</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-500/10 rounded-xl flex items-center justify-center">
                                    <i class="fa fa-check text-blue-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 border border-orange-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-orange-600 font-medium">退订未发送</p>
                                    <p id="unsubscribedCount" class="text-2xl font-bold text-orange-900">0</p>
                                </div>
                                <div class="w-12 h-12 bg-orange-500/10 rounded-xl flex items-center justify-center">
                                    <i class="fa fa-ban text-orange-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border border-green-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-green-600 font-medium">无退订</p>
                                    <p id="noUnsubscribeCount" class="text-2xl font-bold text-green-900">0</p>
                                </div>
                                <div class="w-12 h-12 bg-green-500/10 rounded-xl flex items-center justify-center">
                                    <i class="fa fa-heart text-green-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-4 border border-red-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-red-600 font-medium">未发送</p>
                                    <p id="notSentCount" class="text-2xl font-bold text-red-900">0</p>
                                </div>
                                <div class="w-12 h-12 bg-red-500/10 rounded-xl flex items-center justify-center">
                                    <i class="fa fa-times text-red-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 图表容器 -->
                    <div class="h-64">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <!-- 详细列表卡片 -->
                <div class="bg-white rounded-2xl shadow-xl p-6 card-hover border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-900 flex items-center">
                            <i class="fa fa-list text-danger mr-3"></i>
                            详细列表
                        </h2>
                        <div class="flex space-x-2">
                            <select id="filterSelect" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="all">全部</option>
                                <option value="sent">已发送</option>
                                <option value="unsubscribed">退订未发送</option>
                                <option value="no-unsubscribe">无退订</option>
                                <option value="not-sent">未发送</option>
                            </select>
                            <button id="exportBtn" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                                <i class="fa fa-download mr-1"></i>导出
                            </button>
                        </div>
                    </div>
                    
                    <!-- 列表容器 -->
                    <div class="space-y-2 max-h-96 overflow-y-auto scrollbar-hide" id="resultList">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fa fa-inbox text-4xl mb-3 opacity-50"></i>
                            <p>请粘贴数据并点击分析按钮</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 未发送人员卡片（底部） -->
        <div id="missingPersonsCard" class="mt-8 bg-white rounded-2xl shadow-xl p-6 card-hover border border-gray-100 hidden animate-slide-up" style="animation-delay: 0.4s">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900 flex items-center">
                    <i class="fa fa-exclamation-triangle text-warning mr-3"></i>
                    未发送人员名单
                </h2>
                <span id="missingCount" class="text-lg font-bold text-warning">0</span>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3" id="missingPersonsList">
                <!-- 未发送人员将在这里显示 -->
            </div>
        </div>
    </div>

    <!-- 帮助模态框 -->
    <div id="helpModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto animate-slide-up">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-900">使用帮助</h3>
                    <button id="closeHelpBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">1. 数据格式要求</h4>
                    <div class="bg-gray-50 p-4 rounded-lg font-mono text-sm">
                        <p>张三 已发送，退订的未发送</p>
                        <p>李四 已发送 无退订</p>
                        <p>王五 未发送</p>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">2. 状态识别规则</h4>
                    <ul class="space-y-1 text-sm text-gray-600">
                        <li>• 包含"退订"关键词：识别为退订未发送</li>
                        <li>• 包含"无退订"：识别为无退订</li>
                        <li>• 包含"已发送"但无退订信息：识别为已发送</li>
                        <li>• 包含"未发送"：识别为未发送</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">3. 数据库功能</h4>
                    <p class="text-sm text-gray-600">
                        在数据库区域输入完整的人员名单，系统会自动对比并找出未出现在输入数据中的人员。
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据库管理模态框 -->
    <div id="dbModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto animate-slide-up">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-900">数据库管理</h3>
                    <button id="closeDbBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <button id="importDBBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        <i class="fa fa-upload mr-2"></i>导入文件
                    </button>
                    <button id="exportDBBtn" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-colors">
                        <i class="fa fa-download mr-2"></i>导出数据库
                    </button>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">数据库统计</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg text-center">
                            <p class="text-sm text-gray-600">总人数</p>
                            <p id="dbTotalCount" class="text-lg font-bold">0</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <p class="text-sm text-green-600">已发送</p>
                            <p id="dbSentCount" class="text-lg font-bold">0</p>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <p class="text-sm text-red-600">未发送</p>
                            <p id="dbMissingCount" class="text-lg font-bold">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知组件 -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden animate-slide-up">
        <div class="bg-white rounded-xl shadow-lg p-4 border-l-4 border-primary flex items-center space-x-3 max-w-sm">
            <div class="w-8 h-8 bg-primary/10 rounded-lg flex items-center justify-center">
                <i id="notificationIcon" class="fa fa-check text-primary"></i>
            </div>
            <div>
                <p id="notificationTitle" class="font-semibold text-gray-900">操作成功</p>
                <p id="notificationMessage" class="text-sm text-gray-600">数据已成功处理</p>
            </div>
        </div>
    </div>

    <script>
        class RCTMailTracker {
            constructor() {
                this.initializeElements();
                this.initializeEventListeners();
                this.initializeChart();
                this.loadFromLocalStorage();
                this.updateDisplay();
            }

            initializeElements() {
                // 输入元素
                this.dataInput = document.getElementById('dataInput');
                this.databaseInput = document.getElementById('databaseInput');
                
                // 按钮元素
                this.analyzeBtn = document.getElementById('analyzeBtn');
                this.pasteBtn = document.getElementById('pasteBtn');
                this.saveDBBtn = document.getElementById('saveDBBtn');
                this.loadSampleBtn = document.getElementById('loadSampleBtn');
                this.resetBtn = document.getElementById('resetBtn');
                this.helpBtn = document.getElementById('helpBtn');
                this.manageDBBtn = document.getElementById('manageDBBtn');
                this.exportBtn = document.getElementById('exportBtn');
                
                // 统计元素
                this.totalCount = document.getElementById('totalCount');
                this.sentCount = document.getElementById('sentCount');
                this.unsubscribedCount = document.getElementById('unsubscribedCount');
                this.noUnsubscribeCount = document.getElementById('noUnsubscribeCount');
                this.notSentCount = document.getElementById('notSentCount');
                
                // 列表元素
                this.resultList = document.getElementById('resultList');
                this.missingPersonsCard = document.getElementById('missingPersonsCard');
                this.missingPersonsList = document.getElementById('missingPersonsList');
                this.missingCount = document.getElementById('missingCount');
                
                // 模态框元素
                this.helpModal = document.getElementById('helpModal');
                this.dbModal = document.getElementById('dbModal');
                this.closeHelpBtn = document.getElementById('closeHelpBtn');
                this.closeDbBtn = document.getElementById('closeDbBtn');
                
                // 数据库统计元素
                this.dbTotalCount = document.getElementById('dbTotalCount');
                this.dbSentCount = document.getElementById('dbSentCount');
                this.dbMissingCount = document.getElementById('dbMissingCount');
                
                // 其他元素
                this.filterSelect = document.getElementById('filterSelect');
                this.notification = document.getElementById('notification');
                this.notificationTitle = document.getElementById('notificationTitle');
                this.notificationMessage = document.getElementById('notificationMessage');
                this.notificationIcon = document.getElementById('notificationIcon');
            }

            initializeEventListeners() {
                // 主要功能按钮
                this.analyzeBtn.addEventListener('click', () => this.analyzeData());
                this.pasteBtn.addEventListener('click', () => this.pasteFromClipboard());
                this.saveDBBtn.addEventListener('click', () => this.saveDatabase());
                this.loadSampleBtn.addEventListener('click', () => this.loadSampleData());
                this.resetBtn.addEventListener('click', () => this.resetAll());
                this.exportBtn.addEventListener('click', () => this.exportResults());
                
                // 模态框按钮
                this.helpBtn.addEventListener('click', () => this.showModal('help'));
                this.manageDBBtn.addEventListener('click', () => this.showModal('db'));
                this.closeHelpBtn.addEventListener('click', () => this.hideModal('help'));
                this.closeDbBtn.addEventListener('click', () => this.hideModal('db'));
                
                // 过滤和其他
                this.filterSelect.addEventListener('change', () => this.updateDisplay());
                this.dataInput.addEventListener('input', () => this.updateCharacterCount());
                
                // 点击模态框背景关闭
                this.helpModal.addEventListener('click', (e) => {
                    if (e.target === this.helpModal) this.hideModal('help');
                });
                this.dbModal.addEventListener('click', (e) => {
                    if (e.target === this.dbModal) this.hideModal('db');
                });
            }

            initializeChart() {
                const ctx = document.getElementById('statusChart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['已发送', '退订未发送', '无退订', '未发送'],
                        datasets: [{
                            data: [0, 0, 0, 0],
                            backgroundColor: [
                                '#3B82F6', // 蓝色
                                '#F59E0B', // 橙色
                                '#10B981', // 绿色
                                '#EF4444'  // 红色
                            ],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            duration: 1000
                        }
                    }
                });
            }

            async analyzeData() {
                const input = this.dataInput.value.trim();
                if (!input) {
                    this.showNotification('错误', '请先输入数据', 'error');
                    return;
                }

                try {
                    this.showNotification('处理中', '正在分析数据...', 'info');
                    
                    // 解析数据
                    const lines = input.split('\n').filter(line => line.trim() !== '');
                    const results = [];
                    
                    lines.forEach((line, index) => {
                        const result = this.parseLine(line.trim());
                        if (result) {
                            results.push({
                                ...result,
                                index: index + 1
                            });
                        }
                    });

                    // 保存结果
                    this.analysisResults = results;
                    this.updateDisplay();
                    this.saveToLocalStorage();
                    
                    this.showNotification('成功', `分析完成，共处理 ${results.length} 条记录`, 'success');
                    
                } catch (error) {
                    console.error('分析数据时出错:', error);
                    this.showNotification('错误', '数据格式错误，请检查输入', 'error');
                }
            }

            parseLine(line) {
                // 正则表达式匹配姓名和状态
                const nameMatch = line.match(/^([^，, ]+)/);
                if (!nameMatch) return null;
                
                const name = nameMatch[1].trim();
                const statusText = line.substring(name.length).trim();
                
                let status = 'unknown';
                let statusClass = 'bg-gray-100 text-gray-700';
                let statusIcon = 'fa-question';
                
                if (statusText.includes('退订') && statusText.includes('未发送')) {
                    status = 'unsubscribed';
                    statusClass = 'bg-orange-100 text-orange-700';
                    statusIcon = 'fa-ban';
                } else if (statusText.includes('无退订')) {
                    status = 'no-unsubscribe';
                    statusClass = 'bg-green-100 text-green-700';
                    statusIcon = 'fa-heart';
                } else if (statusText.includes('已发送')) {
                    status = 'sent';
                    statusClass = 'bg-blue-100 text-blue-700';
                    statusIcon = 'fa-check';
                } else if (statusText.includes('未发送')) {
                    status = 'not-sent';
                    statusClass = 'bg-red-100 text-red-700';
                    statusIcon = 'fa-times';
                }

                return {
                    name,
                    statusText,
                    status,
                    statusClass,
                    statusIcon
                };
            }

            updateDisplay() {
                if (!this.analysisResults || this.analysisResults.length === 0) {
                    this.resultList.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fa fa-inbox text-4xl mb-3 opacity-50"></i>
                            <p>请粘贴数据并点击分析按钮</p>
                        </div>
                    `;
                    return;
                }

                const filter = this.filterSelect.value;
                const filteredResults = filter === 'all' 
                    ? this.analysisResults 
                    : this.analysisResults.filter(item => item.status === filter);

                // 更新统计
                this.updateStatistics();
                
                // 更新图表
                this.updateChart();
                
                // 更新列表
                this.updateResultList(filteredResults);
                
                // 更新未发送人员
                this.updateMissingPersons();
            }

            updateStatistics() {
                const total = this.analysisResults.length;
                const sent = this.analysisResults.filter(item => item.status === 'sent').length;
                const unsubscribed = this.analysisResults.filter(item => item.status === 'unsubscribed').length;
                const noUnsubscribe = this.analysisResults.filter(item => item.status === 'no-unsubscribe').length;
                const notSent = this.analysisResults.filter(item => item.status === 'not-sent').length;

                // 更新数字显示
                this.totalCount.textContent = total;
                this.sentCount.textContent = sent;
                this.unsubscribedCount.textContent = unsubscribed;
                this.noUnsubscribeCount.textContent = noUnsubscribe;
                this.notSentCount.textContent = notSent;

                // 添加数字动画
                this.animateNumber(this.totalCount, total);
                this.animateNumber(this.sentCount, sent);
                this.animateNumber(this.unsubscribedCount, unsubscribed);
                this.animateNumber(this.noUnsubscribeCount, noUnsubscribe);
                this.animateNumber(this.notSentCount, notSent);
            }

            updateChart() {
                const sent = this.analysisResults.filter(item => item.status === 'sent').length;
                const unsubscribed = this.analysisResults.filter(item => item.status === 'unsubscribed').length;
                const noUnsubscribe = this.analysisResults.filter(item => item.status === 'no-unsubscribe').length;
                const notSent = this.analysisResults.filter(item => item.status === 'not-sent').length;

                this.chart.data.datasets[0].data = [sent, unsubscribed, noUnsubscribe, notSent];
                this.chart.update('active');
            }

            updateResultList(results) {
                if (results.length === 0) {
                    this.resultList.innerHTML = `
                        <div class="text-center text-gray-500 py-6">
                            <i class="fa fa-filter text-2xl mb-2 opacity-50"></i>
                            <p>没有匹配的数据</p>
                        </div>
                    `;
                    return;
                }

                this.resultList.innerHTML = results.map(item => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors border border-gray-200">
                        <div class="flex items-center space-x-3">
                            <span class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-xs font-medium text-gray-700">
                                ${item.index}
                            </span>
                            <span class="font-medium text-gray-900">${item.name}</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${item.statusClass} flex items-center">
                                <i class="fa ${item.statusIcon} mr-1"></i>
                                ${this.getStatusText(item.status)}
                            </span>
                            <span class="text-xs text-gray-500 truncate max-w-xs">${item.statusText}</span>
                        </div>
                    </div>
                `).join('');
            }

            updateMissingPersons() {
                const dbNames = this.getDatabaseNames();
                if (dbNames.length === 0) {
                    this.missingPersonsCard.classList.add('hidden');
                    return;
                }

                const processedNames = this.analysisResults.map(item => item.name.trim());
                const missingNames = dbNames.filter(name => 
                    !processedNames.includes(name.trim()) && name.trim() !== ''
                );

                if (missingNames.length === 0) {
                    this.missingPersonsCard.classList.add('hidden');
                    return;
                }

                this.missingPersonsCard.classList.remove('hidden');
                this.missingCount.textContent = missingNames.length;

                this.missingPersonsList.innerHTML = missingNames.map(name => `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                        <span class="text-sm font-medium text-red-900">${name}</span>
                    </div>
                `).join('');

                // 更新数据库统计
                this.dbTotalCount.textContent = dbNames.length;
                this.dbSentCount.textContent = processedNames.length;
                this.dbMissingCount.textContent = missingNames.length;
            }

            getStatusText(status) {
                const statusMap = {
                    'sent': '已发送',
                    'unsubscribed': '退订未发送',
                    'no-unsubscribe': '无退订',
                    'not-sent': '未发送',
                    'unknown': '未知'
                };
                return statusMap[status] || '未知';
            }

            getDatabaseNames() {
                return this.databaseInput.value.split('\n')
                    .map(name => name.trim())
                    .filter(name => name !== '');
            }

            async pasteFromClipboard() {
                try {
                    const text = await navigator.clipboard.readText();
                    this.dataInput.value = text;
                    this.showNotification('成功', '已从剪贴板粘贴数据', 'success');
                } catch (error) {
                    console.error('粘贴失败:', error);
                    this.showNotification('错误', '无法访问剪贴板', 'error');
                }
            }

            saveDatabase() {
                const dbContent = this.databaseInput.value.trim();
                if (dbContent) {
                    localStorage.setItem('rctDatabase', dbContent);
                    this.showNotification('成功', '数据库已保存', 'success');
                    this.updateMissingPersons();
                } else {
                    this.showNotification('警告', '数据库内容为空', 'warning');
                }
            }

            loadSampleData() {
                const sampleData = `郑嘉诚 已发送，退订的未发送
尹力慧 已发送，退订的未发送
郭雅森 已发送，退订的未发送
战友欣 已发送，退订的未发送
郭虔 已发送，退订的未发送
田馨 已发送，退订的未发送
王旭 已发送，退订的未发送
闫政婷 已发送，退订的未发送
王琦 已发送，退订的未发送
郭晓林 已发送 退订未发送`;

                this.dataInput.value = sampleData;
                this.showNotification('成功', '已加载示例数据', 'success');
            }

            resetAll() {
                if (confirm('确定要重置所有数据吗？')) {
                    this.dataInput.value = '';
                    this.analysisResults = [];
                    this.updateDisplay();
                    this.showNotification('成功', '所有数据已重置', 'success');
                }
            }

            exportResults() {
                if (!this.analysisResults || this.analysisResults.length === 0) {
                    this.showNotification('错误', '没有数据可导出', 'error');
                    return;
                }

                const csvContent = this.generateCSV();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `疫苗RCT邮件统计_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                this.showNotification('成功', '数据已导出为CSV文件', 'success');
            }

            generateCSV() {
                const headers = ['序号', '姓名', '状态', '原始状态文本'];
                const rows = this.analysisResults.map((item, index) => [
                    index + 1,
                    item.name,
                    this.getStatusText(item.status),
                    item.statusText
                ]);

                const csvRows = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(','))
                ];

                return csvRows.join('\n');
            }

            showModal(type) {
                if (type === 'help') {
                    this.helpModal.classList.remove('hidden');
                    this.helpModal.classList.add('flex');
                } else if (type === 'db') {
                    this.dbModal.classList.remove('hidden');
                    this.dbModal.classList.add('flex');
                    this.updateMissingPersons(); // 更新数据库统计
                }
            }

            hideModal(type) {
                if (type === 'help') {
                    this.helpModal.classList.add('hidden');
                    this.helpModal.classList.remove('flex');
                } else if (type === 'db') {
                    this.dbModal.classList.add('hidden');
                    this.dbModal.classList.remove('flex');
                }
            }

            showNotification(title, message, type = 'info') {
                this.notificationTitle.textContent = title;
                this.notificationMessage.textContent = message;

                // 设置图标和颜色
                const iconMap = {
                    'success': 'fa-check-circle text-green-500',
                    'error': 'fa-exclamation-circle text-red-500',
                    'warning': 'fa-exclamation-triangle text-yellow-500',
                    'info': 'fa-info-circle text-blue-500'
                };

                const borderColorMap = {
                    'success': 'border-green-500',
                    'error': 'border-red-500',
                    'warning': 'border-yellow-500',
                    'info': 'border-blue-500'
                };

                this.notificationIcon.className = `fa ${iconMap[type]}`;
                this.notification.querySelector('div').className = `bg-white rounded-xl shadow-lg p-4 border-l-4 ${borderColorMap[type]} flex items-center space-x-3 max-w-sm`;

                // 显示通知
                this.notification.classList.remove('hidden');

                // 3秒后自动隐藏
                setTimeout(() => {
                    this.notification.classList.add('hidden');
                }, 3000);
            }

            animateNumber(element, target) {
                const start = parseInt(element.textContent) || 0;
                const duration = 1000;
                const startTime = Date.now();

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const current = Math.floor(start + (target - start) * progress);
                    element.textContent = current;

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };

                animate();
            }

            saveToLocalStorage() {
                const data = {
                    analysisResults: this.analysisResults,
                    database: this.databaseInput.value
                };
                localStorage.setItem('rctMailTracker', JSON.stringify(data));
            }

            loadFromLocalStorage() {
                const saved = localStorage.getItem('rctMailTracker');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.analysisResults = data.analysisResults || [];
                    this.databaseInput.value = data.database || '';
                }

                const savedDB = localStorage.getItem('rctDatabase');
                if (savedDB) {
                    this.databaseInput.value = savedDB;
                }
            }

            updateCharacterCount() {
                // 可以添加字符计数功能
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            new RCTMailTracker();
        });

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'v':
                        if (e.target === document.getElementById('dataInput')) {
                            e.preventDefault();
                            // 让默认粘贴行为处理
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        if (e.target === document.getElementById('databaseInput')) {
                            document.getElementById('saveDBBtn').click();
                        }
                        break;
                    case 'Enter':
                        if (e.target === document.getElementById('dataInput')) {
                            e.preventDefault();
                            document.getElementById('analyzeBtn').click();
                        }
                        break;
                }
            }
            
            if (e.key === 'Escape') {
                // 关闭所有模态框
                const modals = document.querySelectorAll('[id$="Modal"]');
                modals.forEach(modal => {
                    if (!modal.classList.contains('hidden')) {
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                    }
                });
            }
        });
    </script>
</body>
</html>